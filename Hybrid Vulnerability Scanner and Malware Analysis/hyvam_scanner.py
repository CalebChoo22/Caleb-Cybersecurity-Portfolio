# hyvam_scanner.py
# Hybrid Vulnerability and Malware Scanner

import os
import subprocess
import hashlib
import json
import yara
import time

# Vulnerability Scanner

def run_lynis():
    print("[*] Running Lynis audit (requires sudo)...")
    subprocess.run(['sudo', 'lynis', 'audit', 'system'])

def run_nmap(target='localhost'):
    print(f"[*] Running Nmap scan on {target}...")
    result = subprocess.run(['nmap', '-sS', '-sV', '-O', target], capture_output=True, text=True)
    with open('nmap_results.txt', 'w') as f:
        f.write(result.stdout)
    print("[+] Nmap scan saved to nmap_results.txt")

# 2. Malware Analysis

def hash_file(file_path):
    with open(file_path, 'rb') as f:
        data = f.read()
        return hashlib.md5(data).hexdigest(), hashlib.sha256(data).hexdigest()

def extract_strings(file_path):
    result = subprocess.run(['strings', file_path], capture_output=True, text=True)
    return result.stdout.splitlines()

def run_yara(file_path, yara_rule_path='test_eicar_rule.yar'):
    rules = yara.compile(filepath=yara_rule_path)
    matches = rules.match(file_path)
    return [match.rule for match in matches]

def analyze_file(file_path, yara_rule_path='test_eicar_rule.yar'):
    print(f"[*] Analyzing file: {file_path}")

    # Hashing
    md5, sha256 = hash_file(file_path)
    print(f"[+] MD5:    {md5}")
    print(f"[+] SHA256: {sha256}")

    # Strings
    strings_output = extract_strings(file_path)

    # YARA match
    yara_matches = run_yara(file_path, yara_rule_path)
    print(f"[+] YARA Matches: {yara_matches}")

    # Save report
    report = {
        'file': file_path,
        'md5': md5,
        'sha256': sha256,
        'strings': strings_output[:15],
        'yara_matches': yara_matches
    }

    with open('malware_report.json', 'w') as f:
        json.dump(report, f, indent=4)

    print("[\u2713] Malware analysis complete. Report saved to malware_report.json")

#  Main Menu

def main():
    print("\n=== HYVAM: Hybrid Vulnerability and Malware Scanner ===\n")
    print("1. Run system vulnerability scan (Lynis + Nmap)")
    print("2. Run malware analysis on a file")
    print("3. Exit\n")

    choice = input("Select an option (1/2/3): ").strip()

    if choice == '1':
        run_lynis()
        run_nmap()
    elif choice == '2':
        file_path = input("Enter path to file for malware analysis: ").strip()
        analyze_file(file_path)
    elif choice == '3':
        print("Goodbye!")
    else:
        print("Invalid option. Try again.")

if __name__ == "__main__":
    main()