# Hybrid Vulnerability and Malware Scanner

import os
import subprocess
import hashlib
import yara
import time

# Vulnerability Scanner

# Runs a system audit using Lynis
def run_lynis():
    print("[*] Running Lynis audit (requires sudo)...")
    subprocess.run(['sudo', 'lynis', 'audit', 'system'])

# Performs a scan on the target using Nmap
def run_nmap(target='localhost'):
    print(f"[*] Running Nmap scan on {target}...")
    result = subprocess.run(['nmap', '-sS', '-sV', '-oN', 'nmap_results.txt', target], capture_output=True, text=True)
    print("[+] Nmap scan saved to nmap_results.txt")

# Malware Scanner

def run_yara(file_path, yara_rule_path):
    try:
        rules = yara.compile(filepath=yara_rule_path)
        matches = rules.match(file_path)
        return matches
    except yara.Error as e:
        print(f"[!] YARA error: {e}")
        return []

# Analyzes a file
def analyze_file(file_path):
    if not os.path.isfile(file_path):
        print(f"[!] File not found: {file_path}")
        return

    print(f"[*] Analyzing file: {file_path}")
    with open(file_path, 'rb') as f:
        content = f.read()
        print(f"[+] MD5: {hashlib.md5(content).hexdigest()}")
        print(f"[+] SHA256: {hashlib.sha256(content).hexdigest()}")

    yara_rule_path = input("Enter path to YARA rules file: ").strip()
    if not os.path.isfile(yara_rule_path):
        print(f"[!] YARA rule file not found: {yara_rule_path}")
        return

    yara_matches = run_yara(file_path, yara_rule_path)
    if yara_matches:
        print("[+] YARA Match(es) Found:")
        for match in yara_matches:
            print(f"  - Rule: {match.rule}")
        with open("yara_results.txt", "w") as out:
            out.write(f"Matches for {file_path}:\n")
            for match in yara_matches:
                out.write(f"- {match.rule}\n")
    else:
        print("[âœ“] No YARA matches found.")

# Main Program Loop

def main():
    while True:
        print("\n=== HYVAM: Hybrid Vulnerability and Malware Scanner ===")
        print("1. Run system vulnerability scan (Lynis + Nmap)")
        print("2. Run malware analysis on a file")
        print("3. Exit")

        choice = input("Select an option (1/2/3): ").strip()
        if choice == "1":
            # Runs the vulnerability scanner tools
            run_lynis()
            run_nmap()
        elif choice == "2":
            # Prompts for file and runs the malware scan
            file_path = input("Enter path to file for malware analysis: ").strip()
            analyze_file(file_path)
        elif choice == "3":
            print("Exiting.")
            break
        else:
            print("[!] Invalid choice. Please select 1, 2, or 3.")

if __name__ == "__main__":
    main()
